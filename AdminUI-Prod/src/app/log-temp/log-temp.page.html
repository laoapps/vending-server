<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Device Diagnostics</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="container">

    <!-- Date Range Picker -->
    <ion-card class="filter-card">
      <ion-card-header>

        <ion-card-title>
          <ion-icon name="calendar-outline"></ion-icon>
          Select Time Range
        </ion-card-title>

      </ion-card-header>

      <ion-card-content>
        <ion-item>
          <ion-label position="stacked">From</ion-label>
          <ion-datetime presentation="date-time" [(ngModel)]="fromDate" display-format="YYYY-MM-DD HH:mm"
            hour-cycle="h23">
          </ion-datetime>
        </ion-item>

        <ion-item class="ion-margin-top">
          <ion-label position="stacked">To</ion-label>
          <ion-datetime presentation="date-time" [(ngModel)]="toDate" display-format="YYYY-MM-DD HH:mm"
            hour-cycle="h23">
          </ion-datetime>
        </ion-item>

        <ion-button expand="block" color="primary" class="ion-margin-top" (click)="fetchReport()" [disabled]="loading">
          <ion-spinner *ngIf="loading" name="crescent"></ion-spinner>
          <span *ngIf="!loading">Analyze Devices</span>
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- ADH814 Motor Summary -->
    <ion-card *ngIf="totalFinishedRuns > 0" class="summary-card ion-margin-top">
      <ion-card-header color="primary">
        <ion-card-subtitle>Motor Run Summary</ion-card-subtitle>
        <ion-card-title>{{ totalFinishedRuns }} Runs Completed</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-grid>
          <ion-row class="ion-align-items-center">
            <ion-col size="4">
              <ion-item lines="none" color="success">
                <ion-icon name="checkmark-circle" size="large" slot="start"></ion-icon>
                <ion-label text-center>
                  <h2>{{ healthyRuns }}</h2>
                  <p>Healthy</p>
                </ion-label>
              </ion-item>
            </ion-col>
            <ion-col size="4">
              <ion-item lines="none" [color]="failedRuns > 0 ? 'danger' : 'medium'">
                <ion-icon [name]="failedRuns > 0 ? 'close-circle' : 'remove-circle'" size="large"
                  slot="start"></ion-icon>
                <ion-label text-center>
                  <h2>{{ failedRuns }}</h2>
                  <p>Failed</p>
                </ion-label>
              </ion-item>
            </ion-col>
            <ion-col size="4">
              <ion-item lines="none" color="primary">
                <ion-icon name="trending-up" size="large" slot="start"></ion-icon>
                <ion-label text-center>
                  <h2>{{ successRate }}%</h2>
                  <p>Success Rate</p>
                </ion-label>
              </ion-item>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- Finished Motor Runs Summary -->
    <ion-card *ngIf="finishedRuns.length > 0" class="ion-margin-top">
      <ion-card-header color="primary">
        <ion-card-title>
          <ion-icon name="flag-outline"></ion-icon>
          Finished Motor Runs ({{ finishedRuns.length }})
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item *ngFor="let row of finishedRuns" [color]="row.isHealthy ? 'success' : 'danger'">
            <ion-label>
              <h2>Motor #{{ row.motorNumber }} • {{ row.timeDisplay }}</h2>
              <p>
                <strong>Max Current:</strong> {{ row.maxCurrent }} mA
                → <ion-badge [color]="row.maxCurrent > 400 ? 'warning' : row.maxCurrent > 100 ? 'success' : 'danger'">
                  {{ row.maxCurrent > 400 ? 'Heavy Item (500ml+)' : row.maxCurrent > 100 ? 'Light Item' : 'No Load /
                  Broken' }}
                </ion-badge>
              </p>
              <p>Run Time: {{ row.runTime }}s • Temp: {{ row.temperature }}°C</p>
              <p *ngIf="!row.isHealthy" color="danger">
                <ion-icon name="alert-circle"></ion-icon>
                <strong>Motor Failed:</strong>
                {{ row.healthStatus === 'NO_SPIKE' ? 'No current spike → jammed or disconnected' :
                row.healthStatus === 'DROP_FAILED' ? 'Item did not fall' : 'Overcurrent' }}
              </p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Full Detail Table -->
    <ion-card *ngIf="parsedRows.length > 0" class="ion-margin-top">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="list-outline"></ion-icon>
          All Device Events ({{ parsedRows.length }})
        </ion-card-title>
      </ion-card-header>

      <ion-card-content class="ion-no-padding">
        <!-- Header -->
        <ion-item lines="none" class="header-row">
          <ion-grid>
            <ion-row class="ion-text-center">
              <ion-col size="2.2"><strong>Time</strong></ion-col>
              <ion-col size="1.5"><strong>Device</strong></ion-col>
              <ion-col size="1.8"><strong>Status</strong></ion-col>
              <ion-col size="1.3"><strong>Motor</strong></ion-col>
              <ion-col size="1.6"><strong>Max I</strong></ion-col>
              <ion-col size="1.4"><strong>Avg I</strong></ion-col>
              <ion-col size="1.1"><strong>Time</strong></ion-col>
              <ion-col size="1"><strong>Temp</strong></ion-col>
              <ion-col size="1"><strong>Drop</strong></ion-col>
              <ion-col size="1.5"><strong>Health</strong></ion-col>
            </ion-row>
          </ion-grid>
        </ion-item>

        <!-- Rows -->
        <ion-item *ngFor="let row of parsedRows" [color]="getStatusColor(row.status)">
          <ion-grid>
            <ion-row class="ion-align-items-center ion-text-center">

              <!-- Time -->
              <ion-col size="2.2">
                <div class="text-xs font-medium">{{ row.timeDisplay }}</div>
              </ion-col>

              <!-- Device Type -->
              <ion-col size="1.5">
                <ion-badge [color]="row.deviceType === 'ADH814' ? 'primary' : 
                   row.deviceType === 'VMC' ? 'tertiary' : 
                   'medium'">
                  {{ row.deviceType }}
                </ion-badge>
              </ion-col>

              <!-- Status -->
              <ion-col size="1.8">
                <ion-badge [color]="getStatusColor(row.status)">
                  {{ row.statusText }}
                </ion-badge>
              </ion-col>

              <!-- Motor Number -->
              <ion-col size="1.3">
                <strong *ngIf="row.motorNumber !== undefined && row.motorNumber > 0">
                  {{ getMotorDisplay(row.motorNumber) }}
                </strong>
                <span *ngIf="row.motorNumber === undefined || row.motorNumber === 0">-</span>
              </ion-col>

              <!-- Max Current -->
              <ion-col size="1.6">
                <span *ngIf="row.maxCurrent !== undefined"
                  [class.text-danger]="row.maxCurrent < 1000 && row.status === 2"
                  [class.font-bold]="row.maxCurrent < 1000 && row.status === 2">
                  {{ row.maxCurrent }} mA
                </span>
                <span *ngIf="row.maxCurrent === undefined">-</span>
              </ion-col>

              <!-- Avg Current -->
              <ion-col size="1.4">
                <span *ngIf="row.avgCurrent !== undefined">{{ row.avgCurrent }} mA</span>
                <span *ngIf="row.avgCurrent === undefined">-</span>
              </ion-col>

              <!-- Run Time -->
              <ion-col size="1.1">
                <span *ngIf="row.runTime !== undefined">{{ row.runTime }}s</span>
                <span *ngIf="row.runTime === undefined">-</span>
              </ion-col>

              <!-- Temperature -->
              <ion-col size="1">
                <span *ngIf="row.temperature === -40" class="text-danger font-bold">DISCONNECTED</span>
                <span *ngIf="row.temperature === 120" class="text-warning font-bold">SHORTED</span>
                <span *ngIf="row.temperature !== -40 && row.temperature !== 120">
                  {{ row.temperature }}°C
                </span>
              </ion-col>

              <!-- Drop Success -->
              <ion-col size="1">
                <div *ngIf="row.dropSuccess !== undefined">
                  <ion-icon [name]="row.dropSuccess ? 'checkmark-circle' : 'close-circle'"
                    [color]="row.dropSuccess ? 'success' : 'danger'" size="large">
                  </ion-icon>
                </div>
                <span *ngIf="row.dropSuccess === undefined">-</span>
              </ion-col>

              <!-- Health + VMC Status -->
              <ion-col size="1.5">
                <!-- ADH814 Health -->
                <ion-badge *ngIf="row.deviceType === 'ADH814'" [color]="getHealthColor(row.healthStatus)">
                  <strong>
                    {{ row.healthStatus === 'OK' ? 'OK' :
                    row.healthStatus === 'NO_SPIKE' ? 'NO POWER' :
                    row.healthStatus === 'DROP_FAILED' ? 'DROP FAILED' :
                    row.healthStatus === 'OVERCURRENT' ? 'OVERCURRENT' : 'OK' }}
                  </strong>
                </ion-badge>

                <!-- VMC Full Status -->
                <div *ngIf="row.deviceType === 'VMC' && row.vmcStatus" class="ion-text-wrap text-xs">
                  <strong>VMC:</strong><br>
                  Bill={{ row.vmcStatus.billStatus }} |
                  Coin={{ row.vmcStatus.coinStatus }} |
                  Card={{ row.vmcStatus.cardStatus }} |
                  Door={{ row.vmcStatus.doorStatus }} |
                  TempCtrl={{ row.vmcStatus.tempControllerStatus }}
                </div>

                <!-- Other devices -->
                <ion-badge *ngIf="row.deviceType === 'OTHER'" color="medium">
                  ONLINE
                </ion-badge>
              </ion-col>

            </ion-row>
          </ion-grid>
        </ion-item>


      </ion-card-content>
    </ion-card>

    <!-- Raw Data Toggle -->
    <ion-button *ngIf="parsedRows.length > 0" expand="block" fill="outline" class="ion-margin-top"
      (click)="toggleRawData()">
      <ion-icon [name]="showRawData ? 'eye-off-outline' : 'eye-outline'" slot="start"></ion-icon>
      {{ showRawData ? 'Hide' : 'Show' }} Raw Data ({{ parsedRows.length }} records)
    </ion-button>

    <!-- Raw Data -->
    <div *ngIf="showRawData && parsedRows.length > 0" class="ion-padding">
      <ion-card>
        <ion-card-header>
          <ion-card-title>Raw Protocol Data</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list lines="inset">
            <ion-item *ngFor="let row of parsedRows">
              <ion-label class="ion-text-wrap">
                <p class="text-xs">
                  {{ row.timeDisplay }} — {{ row.statusText }}
                  <strong *ngIf="row.motorNumber">• Motor {{ getMotorDisplay(row.motorNumber) }}</strong>
                  <strong *ngIf="row.deviceType === 'VMC'">• VMC Status</strong>
                </p>
                <p class="font-mono text-xs bg-dark text-light px-2 py-1 rounded">
                  {{ row.rawData }}
                </p>
              </ion-label>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading && parsedRows.length === 0" class="empty-state ion-text-center ion-padding">
      <ion-icon name="search-outline" size="large" color="medium"></ion-icon>
      <h3>No Data Found</h3>
      <p>Select a time range and tap "Analyze Devices"</p>
    </div>

  </div>
</ion-content>