<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Machine Logs</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="container">

    <!-- Date Picker -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Select Time Range</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label position="stacked">From</ion-label>
          <ion-datetime presentation="date-time" [(ngModel)]="fromDate" display-format="YYYY-MM-DD HH:mm"></ion-datetime>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">To</ion-label>
          <ion-datetime presentation="date-time" [(ngModel)]="toDate" display-format="YYYY-MM-DD HH:mm"></ion-datetime>
        </ion-item>
        <ion-button expand="block" color="primary" (click)="fetchReport()" [disabled]="loading">
          <ion-spinner *ngIf="loading"></ion-spinner>
          Load Logs
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Events Table -->
    <ion-card *ngIf="parsedRows.length > 0">
      <ion-card-header>
        <ion-card-title>All Events ({{ parsedRows.length }})</ion-card-title>
      </ion-card-header>
      <ion-card-content class="ion-no-padding">
        <ion-list>
          <ion-item lines="none" class="header">
            <ion-grid>
              <ion-row class="ion-text-center">
                <ion-col size="2.5">Time</ion-col>
                <ion-col size="2">Device</ion-col>
                <ion-col size="4">Status</ion-col>
                <ion-col size="3.5">Details</ion-col>
              </ion-row>
            </ion-grid>
          </ion-item>

          <ion-item *ngFor="let row of parsedRows">
            <ion-grid>
              <ion-row class="ion-align-items-center ion-text-center">
                <ion-col size="2.5" class="font-medium">{{ row.timeDisplay }}</ion-col>
                <ion-col size="2">
                  <ion-badge color="dark">{{ row.device }}</ion-badge>
                </ion-col>
                <ion-col size="4">
                  <ion-badge [color]="getHealthColor(row.healthStatus)">
                    {{ row.statusText }}
                  </ion-badge>
                </ion-col>
                <ion-col size="3.5" class="text-xs">
                  <div *ngIf="row.motorNumber !== undefined">
                    Motor #{{ row.motorNumber }} • {{ row.maxCurrent }} mA • {{ row.runTime }}s • {{ row.temperature }}°C
                  </div>
                  <div *ngIf="row.isVMC">VMC Event</div>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-item>
        </ion-list>

        <ion-button expand="block" fill="outline" (click)="toggleRawData()">
          {{ showRawData ? 'Hide' : 'Show' }} Raw Data
        </ion-button>

        <div *ngIf="showRawData" class="ion-padding">
          <ion-card *ngFor="let row of parsedRows">
            <ion-card-content>
              <p class="text-xs">{{ row.timeDisplay }} — {{ row.statusText }}</p>
              <p class="font-mono text-xs bg-dark text-light p-2 rounded">{{ row.rawData }}</p>
            </ion-card-content>
          </ion-card>
        </div>
      </ion-card-content>
    </ion-card>

    <div *ngIf="!loading && parsedRows.length === 0" class="ion-text-center ion-padding">
      <ion-icon name="alert-circle-outline" size="large" color="medium"></ion-icon>
      <p>No data found</p>
    </div>
  </div>
</ion-content>